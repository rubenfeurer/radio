FROM debian:bullseye

# Install system dependencies
RUN apt-get update && \
    apt-get install -y \
    # Python dependencies
    python3-dev \
    python3-pip \
    python3-venv \
    python3.9-venv \
    python3-virtualenv \
    virtualenv \
    build-essential \
    git \
    libssl-dev \
    libffi-dev \
    # Audio dependencies
    pulseaudio \
    alsa-utils \
    # Add backports and install MPV from there
    && echo "deb http://deb.debian.org/debian bookworm main" >> /etc/apt/sources.list \
    && apt-get update \
    && apt-get -y install -t bookworm \
    libmpv1 \
    libmpv-dev \
    mpv \
    && apt-mark hold libmpv1 libmpv-dev mpv \
    # Network dependencies (mock versions for dev)
    && apt-get install -y \
    network-manager \
    wireless-tools \
    # Development tools
    && apt-get install -y \
    lsof \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Create radio user and group
RUN useradd -m -s /bin/bash radio && \
    usermod -aG sudo,audio,pulse,pulse-access radio && \
    echo "radio ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Create directories and set permissions
RUN mkdir -p /home/radio/radio/logs /home/radio/radio/data /tmp/mpv-socket && \
    chown -R radio:radio /home/radio/radio /tmp/mpv-socket

# Switch to radio user
USER radio
WORKDIR /home/radio/radio

# Create and activate virtual environment using virtualenv
RUN virtualenv venv && \
    /home/radio/radio/venv/bin/pip install --upgrade pip

# Install Python dependencies and development tools
COPY --chown=radio:radio install/requirements.txt requirements.txt
COPY --chown=radio:radio install/requirements-dev.txt requirements-dev.txt
RUN /home/radio/radio/venv/bin/pip install -r requirements.txt -r requirements-dev.txt && \
    /home/radio/radio/venv/bin/pip install \
    isort \
    pyupgrade \
    types-requests \
    types-psutil \
    mypy-extensions

# Create stubs directory
RUN mkdir -p /home/radio/radio/src/stubs

# Add auto-formatting git hooks
RUN git config --global core.hooksPath .git/hooks/ && \
    mkdir -p .git/hooks && \
    echo '#!/bin/sh\n\
    black . && \
    ruff check --fix --unsafe-fixes . && \
    ruff check --fix --select F401,F841,F821 . && \
    isort . && \
    pyupgrade --py39-plus $(find . -name "*.py")' > .git/hooks/pre-commit && \
    chmod +x .git/hooks/pre-commit

# Set environment variables
ENV PYTHONPATH=/home/radio/radio
ENV MYPYPATH=/home/radio/radio/src/stubs
ENV MOCK_SERVICES=true
ENV DEV_MODE=true
ENV XDG_RUNTIME_DIR=/run/user/1000
ENV PULSE_RUNTIME_PATH=/run/user/1000/pulse
ENV MOCK_GPIO=true

# Start command
CMD ["/home/radio/radio/venv/bin/python", "-m", "uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "80", "--reload"] 