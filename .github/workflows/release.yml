name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('docker/dev/Dockerfile.backend', 'install/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Build Docker image
      - name: Build development image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/dev/Dockerfile.backend
          load: true
          tags: radio-backend:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # Move cache
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # Run tests
      - name: Run tests in Docker
        run: |
          # Create venv directory
          mkdir -p venv && chmod 777 venv

          docker compose -f docker/docker-compose.dev.yml run --rm \
            --user root \
            -v ${PWD}:/home/radio/radio \
            -e MOCK_SERVICES=true \
            -e MOCK_GPIO=true \
            -e DEV_MODE=true \
            -e PYTHONPATH=/home/radio/radio \
            backend bash -c "
              # Install python3-venv first
              apt-get update && \
              apt-get install -y python3-venv && \

              # Create and setup venv
              python3 -m venv /home/radio/radio/venv && \
              chown -R radio:radio /home/radio/radio && \

              su radio -c '
                source /home/radio/radio/venv/bin/activate && \
                cd /home/radio/radio && \
                pip install -r install/requirements.txt -r install/requirements-dev.txt && \

                # Run tests and ensure output file is created
                python -m pytest \
                  tests/ \
                  --verbose \
                  --cov=src/core \
                  --cov=src/api \
                  --cov=src/hardware \
                  --cov-report=term-missing \
                  --cov-fail-under=50 \
                  --junitxml=/home/radio/radio/pytest-results.xml && \
                chmod 644 /home/radio/radio/pytest-results.xml
              '
            "

      # Test reporting with better error handling
      - name: Test Summary
        uses: test-summary/action@v2
        if: always() && !cancelled() && (success() || failure())
        continue-on-error: true
        with:
          paths: |
            pytest-results.xml

      # Error notification (only for PRs)
      - name: Notify on Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.event.pull_request.number,
              body: '❌ Tests failed in release workflow'
            })

  security-scan:
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run security checks
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          pip install bandit snyk-sdk
          bandit -r src/
          snyk test

  build-dev:
    if: github.ref == 'refs/heads/develop'
    needs: [test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Build frontend
        working-directory: ./web
        run: |
          npm ci
          npm run build

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build for current platform only when using --load
      - name: Build development image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.dev
          platforms: linux/amd64 # Single platform when using --load
          load: true
          tags: radio-dev:latest
          build-args: |
            BUILD_TYPE=development
          cache-from: type=gha,scope=dev
          cache-to: type=gha,scope=dev,mode=max

      # For multi-platform build without --load
      - name: Build multi-platform image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.dev
          platforms: linux/amd64,linux/arm/v7
          push: false # Don't push, just build
          tags: radio-dev:latest
          build-args: |
            BUILD_TYPE=development
          cache-from: type=gha,scope=dev
          cache-to: type=gha,scope=dev,mode=max

      - name: Export development package
        run: |
          VERSION="develop-$(date +'%Y%m%d')-${GITHUB_SHA::7}"
          PACKAGE="radio-${VERSION}"

          mkdir -p dist
          cp -r src/ dist/
          cp -r web/build/ dist/web/
          cp -r install/ dist/
          cp -r config/ dist/
          cp manage_radio.sh dist/
          cp requirements*.txt dist/

          cd dist
          tar -czf ${PACKAGE}.tar.gz ./*
          echo "PACKAGE_NAME=${PACKAGE}.tar.gz" >> $GITHUB_ENV

      - name: Upload development artifact
        uses: actions/upload-artifact@v4
        with:
          name: radio-dev-package
          path: dist/${{ env.PACKAGE_NAME }}
          retention-days: 7

  build-prod:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: [test, security-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push production image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.prod
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: ${{ startsWith(github.ref, 'refs/tags/') }}
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ${{ startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}:{1}', github.repository, github.ref_name) || '' }}
          build-args: |
            BUILD_TYPE=production
          cache-from: type=gha,scope=prod
          cache-to: type=gha,scope=prod,mode=max

      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "ghcr.io/${{ github.repository }}:latest"
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      - name: Export production package
        run: |
          CONTAINER_ID=$(docker create ghcr.io/${{ github.repository }}:latest)
          mkdir -p dist
          docker cp $CONTAINER_ID:/home/radio/radio/. ./dist/
          docker rm $CONTAINER_ID

          VERSION="${GITHUB_REF#refs/tags/}"
          [ -z "$VERSION" ] && VERSION="main-$(date +'%Y%m%d')"
          PACKAGE="radio-${VERSION}"
          cd dist
          tar -czf ${PACKAGE}.tar.gz ./*
          echo "PACKAGE_NAME=${PACKAGE}.tar.gz" >> $GITHUB_ENV

      - name: Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: radio-prod-package
          path: dist/${{ env.PACKAGE_NAME }}

  test-package:
    needs: [build-dev, build-prod]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, debian-latest]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ github.ref == 'refs/heads/develop' && 'radio-dev-package' || 'radio-prod-package' }}

      - name: Test package
        run: |
          tar -xzf *.tar.gz
          ./install.sh --test
          ./radio --version
          ./radio status

  create-release:
    needs: test-package
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: radio-prod-package

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
